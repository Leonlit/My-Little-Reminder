<!DOCTYPE html>
<html>
<head>
  <title>To-do app</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="./main.css"/>
</head>
<body>
  <ul class="nav">
    <li class="nav-item">
      <a class="nav-link" href="#">Clear Task</a>
    </li>
    <li class="nav-item">
      <a class="nav-link disabled" href="#">Source</a>
    </li>
  </ul>
  <form class="container" onsubmit="addNewTaskToStorage(event)">
    <div class="form-group">
        <div>
          <input type="text" class="form-control" id="item" autofocus placeholder="Enter the task name" required />
          <input type="time" class="addGap padding-n" id="newTime" required />
        </div>
        <input type="submit" value="Add Task" class="btn btn-success"/>
    </div>
  </form>
  <div id="taskContainer">
    <div class = "item">sad asds assadas ada </div>
    <div class = "item">2asd asdas asdadsa sdad sdasd adsds dadsad a</div>
    <div class = "item">asd asdsad adsad sada afasds dadsd a das</div>
    <div class = "item">test dsadas dasdasasdsad sdasd asdsad asd sada sad ada da</div>
    <div class = "item">sad asds assadas ada </div>
    <div class = "item">2asd asdas asdadsa sdad sdasd adsds dadsad a</div>
    <div class = "item">asd asdsad adsad sada afasds dadsd a das</div>
    <div class = "item">test dsadas dasdasasdsad sdasd asdsad asd sada sad ada da</div>
  </div>
</body>
</html>
<script src="utilities.js"></script>
<script>
  //# all position starts from zero
  console.log("refreshed");
  const electron = require('electron');
  const {ipcRenderer} = electron;
  const container = document.querySelector('#taskContainer');
  ipcRenderer.send("setupData")
  let allTasks = []

  //when the window is ready and a message is sent from server
  ipcRenderer.on('setupSchedules', function (event, schedules) {
    allTasks = schedules;
    console.log(schedules);
    updateObjectPosition(allTasks);
    setupSchedules(schedules);
  });

  //when update needed to be performed
  ipcRenderer.on('newItemAdded', function (event, schedules) {
    console.log(schedules);
    updateObjectPosition(allTasks)
    updateSchedules(schedules)
  });

  //initial setup for the schedules
  function setupSchedules (schedules) {
    schedules.forEach((objRow, index)=>{
      const item = document.createElement("div");
      item.classList = "item";
      item.setAttribute("id", index);
      // time = objRow.taskTime.join(":");
      // # format time first
      item.textContent = objRow.taskTitle;
      container.appendChild(item);
    })
  }

  //when a new schedule is added
  function addNewSchedules (objRow, position) {
    const item = document.createElement("div");
    item.classList = "item";
    item.setAttribute(position);
    item.textContent = objRow.taskTitle;
    container.insertBefore(item, container.children[position]);
  }

  //adding new item to database
  function addNewTaskToStorage (event) {
    event.preventDefault();
    const title = document.querySelector('#item').value;
    const time = document.querySelector('#newTime').value;
    ipcRenderer.send('addItem', title, time);
  }

  function editSchedule (newTaskObject, position) {
    allTasks[position] = newTaskObject;
    updateObjectPosition();
    const element = container.childNodes[position];
  }

  function updateObjectPosition (taskArr) {
    taskArr.sort(comparer)
  }

  function comparer (obj, obj2) {
    const obj_H = obj.taskTime[0];
    const obj2_H = obj2.taskTime[0];
    if ( obj_H < obj2_H){
      return -1;
    }else if (obj_H == obj2_H) {
      // if the hour is the same, sort using the minute
      const obj_M = obj.taskTime[1];
      const obj2_M = obj2.taskTime[1];
      if (obj_M < obj2_M) {
        return -1
      }else if (obj_M < obj2_M) {
        return 1
      }else {
        return 0;
      }
    }else {
      return 1;
    }
  }
</script>